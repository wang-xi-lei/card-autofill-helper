# 🧪 支付系统测试指南

## 目录
- [测试环境配置](#测试环境配置)
- [测试卡号类型](#测试卡号类型)
- [测试场景](#测试场景)
- [3DS 验证测试](#3ds-验证测试)
- [常见问题排查](#常见问题排查)

---

## 测试环境配置

### 1. 沙盒环境设置

```bash
# 确保使用测试API密钥
PAYMENT_API_KEY=test_sk_xxxxx
ENVIRONMENT=sandbox
```

### 2. 测试模式验证

在开始测试前，确认：
- ✅ 使用的是测试API密钥
- ✅ 数据库指向测试环境
- ✅ 不会创建真实订单
- ✅ 邮件/短信通知已禁用或重定向到测试账号

---

## 测试卡号类型

### A. 自动生成的测试卡（本工具）

**优点：**
- 批量生成
- 通过Luhn算法验证
- 自定义BIN前缀

**用途：**
- 表单验证测试
- UI/UX测试
- 前端逻辑验证
- 输入格式验证

**推荐BIN：**
```
559888     - 通用测试
622126     - 银联测试
421769     - Visa测试
532925     - MasterCard测试
```

### B. 支付处理商官方测试卡

**Stripe测试卡：**
```
4242 4242 4242 4242  - 成功（无3DS）
4000 0027 6000 3184  - 需要3DS验证
4000 0000 0000 0002  - 卡片被拒绝
4000 0000 0000 9995  - 余额不足
4000 0000 0000 0069  - 过期卡片
4000 0000 0000 0127  - CVC验证失败
```

**PayPal Sandbox：**
- 使用PayPal开发者面板创建测试账号
- 不需要真实卡号

**其他处理商：**
- 查阅各支付网关官方文档
- 使用其提供的测试卡号

---

## 测试场景

### 1. 基础表单验证

**测试项目：**
- [ ] 卡号格式验证（Luhn算法）
- [ ] 有效期格式和过期检查
- [ ] CVV格式验证（3位/4位）
- [ ] 必填字段验证
- [ ] 错误提示显示

**使用：** 自动生成的测试卡

### 2. 支付流程测试

**测试项目：**
- [ ] 创建支付意图
- [ ] 支付确认
- [ ] 支付成功/失败处理
- [ ] 回调URL处理
- [ ] 订单状态更新

**使用：** 支付处理商官方测试卡

### 3. 边界情况测试

**测试项目：**
- [ ] 不同卡品牌（Visa, MC, Amex等）
- [ ] 15位卡号（Amex）
- [ ] 16位卡号（Visa, MC等）
- [ ] 过期卡片
- [ ] 无效CVV
- [ ] 卡片被拒绝

**使用：** 混合使用

### 4. 国际化测试

**测试项目：**
- [ ] 不同国家地址格式
- [ ] 邮编格式验证
- [ ] 州/省选择
- [ ] 货币转换
- [ ] 多语言界面

**使用：** 自动生成测试卡 + Faker.js生成地址

---

## 3DS 验证测试

### 什么是3DS？

3D Secure（3DS）是额外的身份验证层，包括：
- **3DS 1.0**: 静态密码
- **3DS 2.0**: 生物识别、OTP等

### 测试不同3DS场景

#### 场景1：无需3DS（摩擦less）
```
卡号: 4242 4242 4242 4242（Stripe）
预期: 直接支付成功，无弹窗
```

#### 场景2：需要3DS验证
```
卡号: 4000 0027 6000 3184（Stripe）
预期: 弹出3DS验证窗口
```

#### 场景3：3DS验证失败
```
卡号: 4000 0000 0000 3220（Stripe）
预期: 3DS验证后失败
```

#### 场景4：3DS不支持
```
卡号: 4242 4242 4242 4242
配置: 强制3DS但卡片不支持
预期: 适当的错误处理
```

### 在您的网站上测试3DS

**步骤：**

1. **启用3DS**
   ```javascript
   // 配置支付时启用3DS
   {
     paymentMethodOptions: {
       card: {
         request_three_d_secure: 'any' // 或 'automatic'
       }
     }
   }
   ```

2. **测试流程**
   - 使用需要3DS的测试卡
   - 验证弹窗是否正确显示
   - 测试验证成功路径
   - 测试验证失败路径
   - 测试用户取消场景

3. **日志记录**
   ```javascript
   // 记录3DS事件
   console.log('3DS challenge presented');
   console.log('3DS authentication status:', status);
   ```

---

## 常见问题排查

### ❌ 问题1: 生成的卡号无法通过验证

**原因：** Luhn算法检查失败

**解决：**
```javascript
// 在控制台验证
const cardNumber = '5598884005115278';
console.log('Luhn验证:', isValidCardNumber(cardNumber));
```

### ❌ 问题2: 支付总是失败

**检查项：**
1. 是否使用测试API密钥？
2. 是否在沙盒模式？
3. 测试卡是否支持您的支付处理商？
4. 查看支付网关日志

### ❌ 问题3: 3DS验证无法触发

**可能原因：**
- 使用了不需要3DS的测试卡
- 3DS未在支付配置中启用
- 网站域名未在支付处理商白名单中

**解决：**
```javascript
// 强制3DS
request_three_d_secure: 'required'
```

### ❌ 问题4: 地址验证失败

**注意：**
- 美国地址需要有效的州缩写
- 邮编格式必须匹配国家
- 某些支付商需要真实存在的地址

**建议：**
使用Faker.js生成符合格式的地址

---

## 测试清单

### 开发阶段
- [ ] 表单UI正确显示所有卡品牌
- [ ] 实时验证反馈（卡号、CVV、日期）
- [ ] 错误信息清晰易懂
- [ ] 加载状态显示正确

### 集成测试
- [ ] 成功支付流程完整
- [ ] 失败支付正确处理
- [ ] Webhook正确接收
- [ ] 订单状态正确更新

### 安全测试
- [ ] 卡号不在日志中明文记录
- [ ] CVV不被存储
- [ ] HTTPS强制使用
- [ ] PCI DSS合规检查

### 用户体验
- [ ] 移动端响应式设计
- [ ] 键盘导航可用
- [ ] 屏幕阅读器支持
- [ ] 多语言支持

---

## 推荐工具

### 测试工具
- **本扩展**: 快速表单填充
- **Postman**: API测试
- **Browser DevTools**: 网络请求检查
- **支付网关仪表板**: 查看测试交易

### 监控工具
- **Sentry**: 错误追踪
- **LogRocket**: 用户会话回放
- **支付网关分析**: 支付成功率监控

---

## 注意事项

### ⚠️ 重要提醒

1. **永远不要在生产环境使用测试卡**
2. **定期清理测试数据**
3. **不要将测试API密钥提交到版本控制**
4. **测试时使用明确的标识（如"TEST"前缀）**
5. **测试完成后验证没有真实费用产生**

### 🔐 安全最佳实践

```javascript
// ❌ 不要这样做
console.log('Card number:', cardNumber);

// ✅ 应该这样
console.log('Card last 4:', cardNumber.slice(-4));
```

---

## 支付处理商测试文档

### Stripe
https://stripe.com/docs/testing

### PayPal
https://developer.paypal.com/tools/sandbox/

### Square
https://developer.squareup.com/docs/testing/test-values

### Adyen
https://docs.adyen.com/development-resources/testing/test-card-numbers

---

## 反馈与改进

如果您发现任何问题或有改进建议：
1. 检查控制台错误日志
2. 验证配置是否正确
3. 查阅支付处理商文档
4. 记录问题重现步骤

---

**祝测试顺利！** 🎉

